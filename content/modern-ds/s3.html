<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lino Galiana">
<meta name="dcterms.date" content="2022-08-28">

<title>Python pour la data science - Les nouveaux modes d’accès aux données : le format parquet et les données sur le cloud</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../content/modern-ds/elastic_approfondissement.html" rel="next">
<link href="../../content/modern-ds/dallE.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #e9f3fa;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
<meta name="twitter:title" content="Python pour la data science - Les nouveaux modes d’accès aux données : le format parquet et les données sur le cloud">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://pythonds.linogaliana.fr/content/modern-ds/python_cloud.png">
<meta name="twitter:image-height" content="1024">
<meta name="twitter:image-width" content="1024">
<meta name="twitter:card" content="summary_large_image">
<meta name="citation_title" content="Python pour la data science">
<meta name="citation_author" content="Lino Galiana">
<meta name="citation_publication_date" content="2023">
<meta name="citation_cover_date" content="2023">
<meta name="citation_year" content="2023">
<meta name="citation_online_date" content="2022-08-28">
<meta name="citation_fulltext_html_url" content="https://pythonds.linogaliana.fr/">
<meta name="citation_doi" content="10.5281/zenodo.8229676">
<meta name="citation_language" content="en">
</head>

<body class="nav-sidebar floating nav-fixed">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Python pour la data science</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-introduction" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Introduction</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-introduction">    
        <li>
    <a class="dropdown-item" href="../../content/getting-started/index.html" rel="" target="">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/getting-started/01_installation.html" rel="" target="">
 <span class="dropdown-text">Configuration de Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/getting-started/02_DS_environment.html" rel="" target="">
 <span class="dropdown-text">L’environnement Python pour la data science</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/getting-started/03_data_analysis.html" rel="" target="">
 <span class="dropdown-text">Comment aborder un jeu de données</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/getting-started/04_python_practice.html" rel="" target="">
 <span class="dropdown-text">Bonne pratique de Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/getting-started/05_rappels_types.html" rel="" target="">
 <span class="dropdown-text">Quelques rappels sur les principes de base de Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/getting-started/06_rappels_fonctions.html" rel="" target="">
 <span class="dropdown-text">Modules, tests, boucles, fonctions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/getting-started/07_rappels_classes.html" rel="" target="">
 <span class="dropdown-text">Les classes en Python</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-manipuler" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Manipuler</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-manipuler">    
        <li>
    <a class="dropdown-item" href="../../content/manipulation/index.html" rel="" target="">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/manipulation/01_numpy.html" rel="" target="">
 <span class="dropdown-text">Numpy, la brique de base de la data science</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/manipulation/02a_pandas_tutorial.html" rel="" target="">
 <span class="dropdown-text">Introduction à Pandas</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/manipulation/02b_pandas_TP.html" rel="" target="">
 <span class="dropdown-text">Pratique de pandas : un exemple complet</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/manipulation/03_geopandas_tutorial.html" rel="" target="">
 <span class="dropdown-text">Données spatiales : découverte de geopandas</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/manipulation/03_geopandas_TP.html" rel="" target="">
 <span class="dropdown-text">Pratique de geopandas avec les données vélib</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/manipulation/04a_webscraping_TP.html" rel="" target="">
 <span class="dropdown-text">Web scraping avec Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/manipulation/04c_API_TP.html" rel="" target="">
 <span class="dropdown-text">Récupérer des données avec des API depuis Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/manipulation/04b_regex_TP.html" rel="" target="">
 <span class="dropdown-text">Maîtriser les expressions régulières</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/manipulation/07_dask.html" rel="" target="">
 <span class="dropdown-text">Introduction à dask grâce aux données DVF</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-communiquer" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Communiquer</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-communiquer">    
        <li>
    <a class="dropdown-item" href="../../content/visualisation/index.html" rel="" target="">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/visualisation/matplotlib.html" rel="" target="">
 <span class="dropdown-text">De beaux graphiques avec python : mise en pratique</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/visualisation/maps.html" rel="" target="">
 <span class="dropdown-text">De belles cartes avec python : mise en pratique</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-modéliser" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Modéliser</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-modéliser">    
        <li>
    <a class="dropdown-item" href="../../content/modelisation/index.html" rel="" target="">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modelisation/0_preprocessing.html" rel="" target="">
 <span class="dropdown-text">Préparation des données pour construire un modèle</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modelisation/1_modelevaluation.html" rel="" target="">
 <span class="dropdown-text">Evaluer la qualité d’un modèle</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modelisation/2_SVM.html" rel="" target="">
 <span class="dropdown-text">Classification: premier modèle avec les SVM</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modelisation/3_regression.html" rel="" target="">
 <span class="dropdown-text">Régression : une introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modelisation/4_featureselection.html" rel="" target="">
 <span class="dropdown-text">Sélection de variables : une introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modelisation/5_clustering.html" rel="" target="">
 <span class="dropdown-text">Clustering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modelisation/6_pipeline.html" rel="" target="">
 <span class="dropdown-text">Premier pas vers l’industrialisation avec les pipelines scikit</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modelisation/7_mlapi.html" rel="" target="">
 <span class="dropdown-text">Mettre à disposition un modèle par le biais d’une API</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-nlp" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">NLP</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-nlp">    
        <li>
    <a class="dropdown-item" href="../../content/NLP/index.html" rel="" target="">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/NLP/01_intro.html" rel="" target="">
 <span class="dropdown-text">Quelques éléments pour comprendre les enjeux du NLP</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/NLP/02_exoclean.html" rel="" target="">
 <span class="dropdown-text">Nettoyer un texte: des exercices pour découvrir l’approche bag-of-words</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/NLP/03_lda.html" rel="" target="">
 <span class="dropdown-text">Latent Dirichlet Allocation (LDA)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/NLP/04_word2vec.html" rel="" target="">
 <span class="dropdown-text">Méthodes de vectorisation : comptages et word embeddings</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/NLP/05_exo_supp.html" rel="" target="">
 <span class="dropdown-text">Exercices supplémentaires</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-approfondissements" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Approfondissements</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-approfondissements">    
        <li>
    <a class="dropdown-item" href="../../content/modern-ds/index.html" rel="" target="">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modern-ds/continuous_integration.html" rel="" target="">
 <span class="dropdown-text">Intégration continue avec Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modern-ds/dallE.html" rel="" target="">
 <span class="dropdown-text">Génération d’images avec Python, DALL-E et StableDiffusion</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modern-ds/s3.html" rel="" target="">
 <span class="dropdown-text">Les nouveaux modes d’accès aux données : le format parquet et les données sur le cloud</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modern-ds/elastic_approfondissement.html" rel="" target="">
 <span class="dropdown-text">Approfondissement ElasticSearch pour des recherches de proximité géographique</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/modern-ds/elastic_intro.html" rel="" target="">
 <span class="dropdown-text">Introduction à ElasticSearch pour la recherche textuelle</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-git" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Git</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-git">    
        <li>
    <a class="dropdown-item" href="../../content/git/index.html" rel="" target="">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/git/introgit.html" rel="" target="">
 <span class="dropdown-text">Git : un élément essentiel au quotidien</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/git/exogit.html" rel="" target="">
 <span class="dropdown-text">Un cadavre exquis pour découvrir Git</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-annexes" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Annexes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-annexes">    
        <li>
    <a class="dropdown-item" href="../../content/annexes/evaluation.html" rel="" target="">
 <span class="dropdown-text">Evaluation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/annexes/corrections.html" rel="" target="">
 <span class="dropdown-text">Corrections</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://linogaliana.github.io/python-datascientist-slides/#/title-slide" rel="" target="">
 <span class="dropdown-text">Slides de présentation</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools ms-auto">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/linogaliana/python-datascientist">
            Code source
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../content/modern-ds/s3.html">Les nouveaux modes d’accès aux données : le format parquet et les données sur le cloud</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns">
                <div id="title-block-header-title" class="quarto-title page-columns page-full page-layout-full featured-image p-4" style="background-image: url(python_cloud.png);">
                <h1 class="title">Les nouveaux modes d’accès aux données : le format parquet et les données sur le cloud</h1>
                                    <div class="quarto-categories">
                        <div class="quarto-category">Tutoriel</div>
                        <div class="quarto-category">Avancé</div>
                      </div>
                          </div>
        
                
        
        <div class="quarto-title-meta">

            <div>
            <div class="quarto-title-meta-heading">Author</div>
            <div class="quarto-title-meta-contents">
                     <p>Lino Galiana </p>
                  </div>
          </div>
            
            <div>
            <div class="quarto-title-meta-heading">Published</div>
            <div class="quarto-title-meta-contents">
              <p class="date">August 28, 2022</p>
            </div>
          </div>
          
            
          </div>
          
        
        
        

        </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/modern-ds/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/modern-ds/continuous_integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intégration continue avec Python</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/modern-ds/dallE.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Génération d’images avec Python, DALL-E et StableDiffusion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/modern-ds/s3.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Les nouveaux modes d’accès aux données : le format parquet et les données sur le cloud</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/modern-ds/elastic_approfondissement.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Approfondissement ElasticSearch pour des recherches de proximité géographique</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/modern-ds/elastic_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction à ElasticSearch pour la recherche textuelle</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#elements-de-contexte" id="toc-elements-de-contexte" class="nav-link active" data-scroll-target="#elements-de-contexte">Elements de contexte</a>
  <ul class="collapse">
  <li><a href="#principe-du-stockage-de-la-donnée" id="toc-principe-du-stockage-de-la-donnée" class="nav-link" data-scroll-target="#principe-du-stockage-de-la-donnée">Principe du stockage de la donnée</a></li>
  <li><a href="#les-fichiers" id="toc-les-fichiers" class="nav-link" data-scroll-target="#les-fichiers">Les fichiers</a></li>
  <li><a href="#les-bases-de-données" id="toc-les-bases-de-données" class="nav-link" data-scroll-target="#les-bases-de-données">Les bases de données</a></li>
  </ul></li>
  <li><a href="#le-format-parquet" id="toc-le-format-parquet" class="nav-link" data-scroll-target="#le-format-parquet">Le format <code>parquet</code></a>
  <ul class="collapse">
  <li><a href="#lire-un-parquet-en-python-la-librairie-pyarrow" id="toc-lire-un-parquet-en-python-la-librairie-pyarrow" class="nav-link" data-scroll-target="#lire-un-parquet-en-python-la-librairie-pyarrow">Lire un <code>parquet</code> en <code>Python</code>: la librairie <code>pyarrow</code></a></li>
  </ul></li>
  <li><a href="#le-système-de-stockage-s3" id="toc-le-système-de-stockage-s3" class="nav-link" data-scroll-target="#le-système-de-stockage-s3">Le système de stockage <code>S3</code></a></li>
  <li><a href="#les-données-sur-le-cloud" id="toc-les-données-sur-le-cloud" class="nav-link" data-scroll-target="#les-données-sur-le-cloud">Les données sur le <em>cloud</em></a>
  <ul class="collapse">
  <li><a href="#quest-ce-que-le-système-de-stockage-s3" id="toc-quest-ce-que-le-système-de-stockage-s3" class="nav-link" data-scroll-target="#quest-ce-que-le-système-de-stockage-s3">Qu’est-ce que le système de stockage <code>S3</code> ?</a></li>
  <li><a href="#comment-faire-avec-python" id="toc-comment-faire-avec-python" class="nav-link" data-scroll-target="#comment-faire-avec-python">Comment faire avec Python ?</a>
  <ul class="collapse">
  <li><a href="#les-librairies-principales" id="toc-les-librairies-principales" class="nav-link" data-scroll-target="#les-librairies-principales">Les librairies principales</a></li>
  </ul></li>
  <li><a href="#connexion-à-un-bucket" id="toc-connexion-à-un-bucket" class="nav-link" data-scroll-target="#connexion-à-un-bucket">Connexion à un bucket</a></li>
  <li><a href="#lister-les-fichiers" id="toc-lister-les-fichiers" class="nav-link" data-scroll-target="#lister-les-fichiers">Lister les fichiers</a></li>
  <li><a href="#télécharger-un-fichier-depuis-s3-pour-lenregistrer-en-local" id="toc-télécharger-un-fichier-depuis-s3-pour-lenregistrer-en-local" class="nav-link" data-scroll-target="#télécharger-un-fichier-depuis-s3-pour-lenregistrer-en-local">Télécharger un fichier depuis <code>S3</code> pour l’enregistrer en local</a></li>
  <li><a href="#lire-un-fichier-directement" id="toc-lire-un-fichier-directement" class="nav-link" data-scroll-target="#lire-un-fichier-directement">Lire un fichier directement</a></li>
  <li><a href="#uploader-un-fichier" id="toc-uploader-un-fichier" class="nav-link" data-scroll-target="#uploader-un-fichier">Uploader un fichier</a></li>
  <li><a href="#pour-aller-plus-loin" id="toc-pour-aller-plus-loin" class="nav-link" data-scroll-target="#pour-aller-plus-loin">Pour aller plus loin</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/linogaliana/python-datascientist/edit/master/content/modern-ds/s3.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/linogaliana/python-datascientist/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">

<!-- source: https://github.com/gadenbuie/garrickadenbuie-com/blob/main/_partials/title-block-link-buttons/title-block.html -->
<!-- source: https://raw.githubusercontent.com/spcanelon/silvia/32853dd0e70a71514b0922ee306f80ed5897f776/_partials/title-block-link-buttons/title-block.html -->
<!-- 
<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title"> 
-->
<!-- <header id="title-block-header" class="quarto-title-block default page-columns"> -->
<!-- <div class="quarto-title page-columns page-full featured-image p-4" style="background-image: url(featured.png), url(featured.jpg), url(../featured.jpg);"> -->
    

<div class="cell markdown">
<p class="badges">
<a href="https://github.com/linogaliana/python-datascientist-notebooks/blob/main/notebooks/NLP/05a_s3.ipynb" class="github"><i class="fab fa-github"></i></a>
<a href="https://downgit.github.io/#/home?url=https://github.com/linogaliana/python-datascientist-notebooks/blob/main/notebooks/NLP/05a_s3.ipynb" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/Download-Notebook-important?logo=Jupyter" alt="Download"></a>
<a href="https://nbviewer.jupyter.org/github/linogaliana/python-datascientist-notebooksblob/main/notebooks/NLP/05a_s3.ipynb" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/Visualize-nbviewer-blue?logo=Jupyter" alt="nbviewer"></a>
<a href="https://datalab.sspcloud.fr/launcher/ide/jupyter-python?autoLaunch=true&amp;onyxia.friendlyName=%C2%ABpython-datascience%C2%BB&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fpython-datascientist%2Fmaster%2Fsspcloud%2Finit-jupyter.sh%C2%BB&amp;init.personalInitArgs=%C2%ABNLP%2005a_s3%C2%BB&amp;security.allowlist.enabled=false" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSP%20Cloud-Tester_avec_Jupyter-orange?logo=Jupyter&amp;logoColor=orange" alt="Onyxia"></a>
<a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=true&amp;onyxia.friendlyName=%C2%ABpython-datascience%C2%BB&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fpython-datascientist%2Fmaster%2Fsspcloud%2Finit-vscode.sh%C2%BB&amp;init.personalInitArgs=%C2%ABNLP%2005a_s3%C2%BB&amp;security.allowlist.enabled=false" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSP%20Cloud-Tester_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia"></a><br>
<a href="https://mybinder.org/v2/gh/linogaliana/python-datascientist-notebooks/main?filepath={binder_path}" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/Launch-Binder-E66581.svg?logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFkAAABZCAMAAABi1XidAAAB8lBMVEX///9XmsrmZYH1olJXmsr1olJXmsrmZYH1olJXmsr1olJXmsrmZYH1olL1olJXmsr1olJXmsrmZYH1olL1olJXmsrmZYH1olJXmsr1olL1olJXmsrmZYH1olL1olJXmsrmZYH1olL1olL0nFf1olJXmsrmZYH1olJXmsq8dZb1olJXmsrmZYH1olJXmspXmspXmsr1olL1olJXmsrmZYH1olJXmsr1olL1olJXmsrmZYH1olL1olLeaIVXmsrmZYH1olL1olL1olJXmsrmZYH1olLna31Xmsr1olJXmsr1olJXmsrmZYH1olLqoVr1olJXmsr1olJXmsrmZYH1olL1olKkfaPobXvviGabgadXmsqThKuofKHmZ4Dobnr1olJXmsr1olJXmspXmsr1olJXmsrfZ4TuhWn1olL1olJXmsqBi7X1olJXmspZmslbmMhbmsdemsVfl8ZgmsNim8Jpk8F0m7R4m7F5nLB6jbh7jbiDirOEibOGnKaMhq+PnaCVg6qWg6qegKaff6WhnpKofKGtnomxeZy3noG6dZi+n3vCcpPDcpPGn3bLb4/Mb47UbIrVa4rYoGjdaIbeaIXhoWHmZYHobXvpcHjqdHXreHLroVrsfG/uhGnuh2bwj2Hxk17yl1vzmljzm1j0nlX1olL3AJXWAAAAbXRSTlMAEBAQHx8gICAuLjAwMDw9PUBAQEpQUFBXV1hgYGBkcHBwcXl8gICAgoiIkJCQlJicnJ2goKCmqK+wsLC4usDAwMjP0NDQ1NbW3Nzg4ODi5+3v8PDw8/T09PX29vb39/f5+fr7+/z8/Pz9/v7+zczCxgAABC5JREFUeAHN1ul3k0UUBvCb1CTVpmpaitAGSLSpSuKCLWpbTKNJFGlcSMAFF63iUmRccNG6gLbuxkXU66JAUef/9LSpmXnyLr3T5AO/rzl5zj137p136BISy44fKJXuGN/d19PUfYeO67Znqtf2KH33Id1psXoFdW30sPZ1sMvs2D060AHqws4FHeJojLZqnw53cmfvg+XR8mC0OEjuxrXEkX5ydeVJLVIlV0e10PXk5k7dYeHu7Cj1j+49uKg7uLU61tGLw1lq27ugQYlclHC4bgv7VQ+TAyj5Zc/UjsPvs1sd5cWryWObtvWT2EPa4rtnWW3JkpjggEpbOsPr7F7EyNewtpBIslA7p43HCsnwooXTEc3UmPmCNn5lrqTJxy6nRmcavGZVt/3Da2pD5NHvsOHJCrdc1G2r3DITpU7yic7w/7Rxnjc0kt5GC4djiv2Sz3Fb2iEZg41/ddsFDoyuYrIkmFehz0HR2thPgQqMyQYb2OtB0WxsZ3BeG3+wpRb1vzl2UYBog8FfGhttFKjtAclnZYrRo9ryG9uG/FZQU4AEg8ZE9LjGMzTmqKXPLnlWVnIlQQTvxJf8ip7VgjZjyVPrjw1te5otM7RmP7xm+sK2Gv9I8Gi++BRbEkR9EBw8zRUcKxwp73xkaLiqQb+kGduJTNHG72zcW9LoJgqQxpP3/Tj//c3yB0tqzaml05/+orHLksVO+95kX7/7qgJvnjlrfr2Ggsyx0eoy9uPzN5SPd86aXggOsEKW2Prz7du3VID3/tzs/sSRs2w7ovVHKtjrX2pd7ZMlTxAYfBAL9jiDwfLkq55Tm7ifhMlTGPyCAs7RFRhn47JnlcB9RM5T97ASuZXIcVNuUDIndpDbdsfrqsOppeXl5Y+XVKdjFCTh+zGaVuj0d9zy05PPK3QzBamxdwtTCrzyg/2Rvf2EstUjordGwa/kx9mSJLr8mLLtCW8HHGJc2R5hS219IiF6PnTusOqcMl57gm0Z8kanKMAQg0qSyuZfn7zItsbGyO9QlnxY0eCuD1XL2ys/MsrQhltE7Ug0uFOzufJFE2PxBo/YAx8XPPdDwWN0MrDRYIZF0mSMKCNHgaIVFoBbNoLJ7tEQDKxGF0kcLQimojCZopv0OkNOyWCCg9XMVAi7ARJzQdM2QUh0gmBozjc3Skg6dSBRqDGYSUOu66Zg+I2fNZs/M3/f/Grl/XnyF1Gw3VKCez0PN5IUfFLqvgUN4C0qNqYs5YhPL+aVZYDE4IpUk57oSFnJm4FyCqqOE0jhY2SMyLFoo56zyo6becOS5UVDdj7Vih0zp+tcMhwRpBeLyqtIjlJKAIZSbI8SGSF3k0pA3mR5tHuwPFoa7N7reoq2bqCsAk1HqCu5uvI1n6JuRXI+S1Mco54YmYTwcn6Aeic+kssXi8XpXC4V3t7/ADuTNKaQJdScAAAAAElFTkSuQmCC" alt="Binder"></a>
<a href="https://colab.research.google.com/github/linogaliana/python-datascientist-notebooks/blob/main/notebooks/NLP/05a_s3.ipynb" target="_blank" rel="noopener"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a>
<a href="https://github.dev/linogaliana/python-datascientist-notebooks/notebooks/NLP/05a_s3.ipynb" target="_blank" rel="noopener"><img src="https://img.shields.io/static/v1?logo=visualstudiocode&amp;label=&amp;message=Open%20in%20Visual%20Studio%20Code&amp;labelColor=2c2c32&amp;color=007acc&amp;logoColor=007acc" alt="githubdev"></a>
</p>
<p></p>
</div>
<p>Ce chapitre est une introduction à la question
du stockage des données et aux innovations
récentes dans ce domaine. L’objectif
est d’abord de présenter les avantages
du format <code>Parquet</code> et la manière dont
on peut utiliser les
librairies <a href="https://arrow.apache.org/docs/python/index.html"><code>pyarrow</code></a>
ou <a href="https://duckdb.org/docs/api/python/overview.html"><code>duckdb</code></a> pour traiter
de manière efficace des données volumineuses
au format <code>Parquet</code>. Ensuite, on présentera
la manière dont ce format <code>parquet</code> s’intègre
bien avec des systèmes de stockage <em>cloud</em>,
qui tendent à devenir la norme dans le monde
de la <em>data science</em>.</p>
<section id="elements-de-contexte" class="level1">
<h1>Elements de contexte</h1>
<section id="principe-du-stockage-de-la-donnée" class="level2">
<h2 class="anchored" data-anchor-id="principe-du-stockage-de-la-donnée">Principe du stockage de la donnée</h2>
<p>Pour comprendre les apports du format <code>Parquet</code>, il est nécessaire
de faire un détour pour comprendre la manière dont une information
est stockée et accessible à un langage de traitement de la donnée.</p>
<p>Il existe deux approches dans le monde du stockage de la donnée.
La première est celle de la <strong>base de données relationnelle</strong>. La seconde est le
principe du <strong>fichier</strong>.
La différence entre les deux est dans la manière dont l’accès aux
données est organisé.</p>
</section>
<section id="les-fichiers" class="level2">
<h2 class="anchored" data-anchor-id="les-fichiers">Les fichiers</h2>
<p>Dans un fichier, les données sont organisées selon un certain format et
le logiciel de traitement de la donnée va aller chercher et structurer
l’information en fonction de ce format. Par exemple, dans un fichier
<code>.csv</code>, les différentes informations seront stockées au même niveau
avec un caractère pour les séparer (la virgule <code>,</code> dans les <code>.csv</code> anglosaxons, le point virgule dans les <code>.csv</code> français, la tabulation dans les <code>.tsv</code>). Le fichier suivant</p>
<pre class="raw"><code>nom ; profession 
Astérix ; 
Obélix ; Tailleur de menhir ;
Assurancetourix ; Barde</code></pre>
<p>sera ainsi organisé naturellement sous forme tabulée par <code>Python</code></p>
<div class="cell" data-execution_count="2">
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">nom</th>
<th data-quarto-table-cell-role="th">profession</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Astérix</td>
<td></td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Obélix</td>
<td>Tailleur de menhir</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Assurancetourix</td>
<td>Barde</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>A propos des fichiers de ce type, on parle de <strong>fichiers plats</strong> car
les enregistrements relatifs à une observation sont stockés ensemble,
sans hiérarchie.</p>
<p>Certains formats de données vont permettre d’organiser les informations
de manière différente. Par exemple, le format <code>JSON</code> va
hiérarchiser différemment la même information [^1]:</p>
<pre class="raw"><code>[
  {
    "nom": "Astérix"
  },
  {
    "nom": "Obélix",
    "profession": "Tailleur de menhir"
  },
  {
    "nom": "Assurancetourix",
    "profession": "Barde"
  }
]</code></pre>
<div class="cell markdown">
<div class="alert alert-warning" role="alert">
<h3 class="alert-heading anchored"><i class="fa-solid fa-lightbulb"></i> Hint </h3>
<p>La différence entre le CSV et le format <code>JSON</code> va au-delà d’un simple “formattage” des données.</p>
<p>Par sa nature non tabulaire, le format JSON permet des mises à jour beaucoup plus facile de la donnée dans les entrepôts de données.</p>
<p>Par exemple, un site web qui collecte de nouvelles données n’aura pas à mettre à jour l’ensemble de ses enregistrements antérieurs
pour stocker la nouvelle donnée (par exemple pour indiquer que pour tel ou tel client cette donnée n’a pas été collectée)
mais pourra la stocker dans
un nouvel item. Ce sera à l’outil de requête (<code>Python</code> ou un autre outil)
de créer une relation entre les enregistrements stockés à des endroits
différents.</p>
<p>Ce type d’approche flexible est l’un des fondements de l’approche <code>NoSQL</code>,
sur laquelle nous allons revenir, qui a permis l’émergence de technologies au coeur de l’écosystème actuel du <em>big-data</em> comme <code>Hadoop</code> ou <code>ElasticSearch</code>.</p>
</div>
</div>
<p>Cette fois, quand on n’a pas d’information, on ne se retrouve pas avec nos deux séparateurs accolés (cf.&nbsp;la ligne <em>“Astérix”</em>) mais l’information
n’est tout simplement pas collectée.</p>
<div class="cell markdown">
<div class="alert alert-info" role="alert">
<h3 class="alert-heading anchored"><i class="fa-solid fa-comment"></i> Note</h3>
<p>Il se peut très bien que l’information sur une observation soit disséminée
dans plusieurs fichiers dont les formats diffèrent.</p>
<p>Par exemple, dans le domaine des données géographiques,
lorsqu’une donnée est disponible sous format de fichier(s), elle peut l’être de deux manières!</p>
<ul>
<li>Soit la donnée est stockée dans un seul fichier qui mélange contours géographiques et valeurs attributaires
(la valeur associée à cette observation géographique, par exemple le taux d’abstention). Ce principe est celui du <code>geojson</code>.</li>
<li>Soit la donnée est stockée dans plusieurs fichiers qui sont spécialisés : un fichier va stocker les contours géographiques,
l’autre les données attributaires et d’autres fichiers des informations annexes (comme le système de projection). Ce principe est celui du <code>shapefile</code>.
C’est alors le logiciel qui requête
les données (<code>Python</code> par exemple) qui saura où aller chercher l’information
dans les différents fichiers et associer celle-ci de manière cohérente.</li>
</ul>
</div>
</div>
<p>Un concept supplémentaire dans le monde du fichier est celui du <strong>file system</strong>. Le <em>file system</em> est
le système de localisation et de nommage des fichiers.
Pour simplifier, le <em>file system</em> est la manière dont votre ordinateur saura
retrouver, dans son système de stockage, les bits présents dans tel ou tel fichier
appartenant à tel ou tel dossier.</p>
</section>
<section id="les-bases-de-données" class="level2">
<h2 class="anchored" data-anchor-id="les-bases-de-données">Les bases de données</h2>
<p>La logique des bases de données est différente. Elle est plus systémique.
Un système de gestion de base de données (<em>Database Management System</em>)
est un logiciel qui gère à la fois le stockage d’un ensemble de données reliée,
permet de mettre à jour celle-ci (ajout ou suppression d’informations, modification
des caractéristiques d’une table…)
et qui gère également
les modalités d’accès à la donnée (type de requête, utilisateurs
ayant les droits en lecture ou en écriture…).</p>
<p>La relation entre les entités présentes dans une base de données
prend généralement la forme d’un <strong>schéma en étoile</strong>. Une base va centraliser
les informations disponibles qui seront ensuite détaillées dans des tables
dédiées.</p>
<p><a href="https://www.databricks.com/wp-content/uploads/2022/04/star-schema-erd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://www.databricks.com/wp-content/uploads/2022/04/star-schema-erd.png" class="img-fluid"></a>
Source: <a href="https://www.databricks.com/fr/glossary/star-schema">La documentation <code>Databricks</code> sur le schéma en étoile</a></p>
<p>Le logiciel associé à la base de données fera ensuite le lien
entre ces tables à partir de requêtes <code>SQL</code>. L’un des logiciels les plus efficaces dans ce domaine
est <a href="https://www.postgresql.org/"><code>PostgreSQL</code></a>. <code>Python</code> est tout à fait
utilisable pour passer une requête SQL à un gestionnaire de base de données.
Les packages <a href="https://www.sqlalchemy.org/"><code>sqlalchemy</code></a> et <a href="https://www.psycopg.org/docs/"><code>psycopg2</code></a>
peuvent servir à utiliser <code>PostgreSQL</code> pour requêter une
base de donnée ou la mettre à jour.</p>
<p>La logique de la base de données est donc très différente de celle du fichier.
Ces derniers sont beaucoup plus légers pour plusieurs raisons.
D’abord, parce qu’ils sont moins adhérents à
un logiciel gestionnaire. Là où le fichier ne nécessite, pour la gestion,
qu’un <em>file system</em>, installé par défaut sur
tout système d’exploitation, une base de données va nécessiter un
logiciel spécialisé. L’inconvénient de l’approche fichier, sous sa forme
standard, est qu’elle
ne permet pas une gestion fine des droits d’accès et amène généralement à une
duplication de la donnée pour éviter que la source initiale soit
ré-écrite (involontairement ou de manière intentionnelle par un utilisateur malveillant).
Résoudre ce problème est l’une des
innovations des systèmes <em>cloud</em>, sur lesquelles nous reviendrons en évoquant le
système <code>S3</code>.
Un deuxième inconvénient de l’approche base de données par
rapport à l’approche fichier, pour un utilisateur de <code>Python</code>,
est que les premiers nécessitent l’intermédiation du logiciel de gestion
de base de données là où, dans le second cas, on va se contenter d’une
librairie, donc un système beaucoup plus léger,
qui sait comment transformer la donnée brute en <code>DataFrame</code>.
Pour ces raisons, entre autres, les bases de données sont donc moins à la
mode dans l’écosystème récent de la <em>data science</em> que les fichiers.</p>
</section>
</section>
<section id="le-format-parquet" class="level1">
<h1>Le format <code>parquet</code></h1>
<p>Le format <code>CSV</code> a rencontré un grand succès par sa simplicité : il
est lisible par un humain (un bloc-note suffit pour l’ouvrir et
apercevoir les premières lignes), sa nature plate lui permet
de bien correspondre au concept de données tabulées sans hiérarchie
qui peuvent être rapidement valorisées, il est universel (il n’est
pas adhérent à un logiciel). Cependant, le CSV présente
plusieurs inconvénients qui justifient l’émergence d’un format
concurrent:</p>
<ul>
<li>le CSV est un format <strong>lourd</strong> car les informations ne sont pas compressées
(ce qui le rend lisible facilement depuis un bloc-note) mais aussi
parce que toutes les données sont stockées de la même manière.
C’est la
librairie faisant l’import qui va essayer d’optimiser le typage des données
pour trouver le typage qui utilise le moins de mémoire possible sans
altération de l’information. En effet, si <code>pandas</code> détermine qu’une colonne
présente les valeurs <code>6 ; 5 ; 0</code>, il va privilégier l’utilisation du type
<code>int</code> au type <code>double</code> qui sera lui même préféré au type <code>object</code> (objets
de type données textuelles). Cependant, pour faire cela, <code>pandas</code> va devoir
scanner un nombre suffisant de valeurs, ce qui demande du temps et expose
à des erreurs (en se fondant sur trop peu de valeurs, on peut se tromper
de typage) ;</li>
<li>le stockage étant <strong>orienté ligne</strong>,
accéder à une information donnée dans un <code>CSV</code> implique
de le lire le fichier en entier, sélectionner la ou les colonnes
d’intérêt et ensuite les lignes désirées. Par exemple, si on désire
connaître uniquement la profession de la deuxième ligne dans l’exemple
plus haut :point_up:, un algorithme de recherche devra:
prendre le fichier, déterminer que la profession est la deuxième colonne,
et ensuite aller chercher la deuxième ligne dans cette colonne. Si
on désire accéder à un sous-ensemble de lignes dont les indices
sont connus, le <code>CSV</code> est intéressant. Cependant,
si on désire accéder à un sous-ensemble
de colonnes dans un fichier (ce qui est un cas d’usage plus fréquent
pour les <em>data scientists</em>), alors le <code>CSV</code> n’est pas le format le plus
approprié ;</li>
<li>mettre à jour la donnée est coûteux car cela implique de réécrire
l’ensemble du fichier. Par exemple, si après une première
analyse de la donnée,
on désire ajouter une colonne, on ne peut accoler ces nouvelles informations
à celles déjà existantes, il est nécessaire de réécrire l’ensemble
du fichier. Pour reprendre l’exemple de nos gaulois préférés, si on veut
ajouter une colonne <code>cheveux</code> entre les deux déjà existantes,
il faudra changer totalement le fichier:</li>
</ul>
<pre class="raw"><code>"""
nom ; cheveux ; profession
Astérix; blond; ; 
Obélix; roux; Tailleur de menhir
Assurancetourix; blond; Barde
"""</code></pre>
<div class="cell markdown">
<div class="alert alert-info" role="alert">
<h3 class="alert-heading anchored"><i class="fa-solid fa-comment"></i> Note</h3>
<p>La plupart des logiciels d’analyse de données proposent
un format de fichier pour sauvegarder des bases de données. On
peut citer le <code>.pickle</code> (<code>Python</code>), le <code>.rda</code> ou <code>.RData</code> (<code>R</code>),
le <code>.dta</code> (<code>Stata</code>) ou le <code>.sas7bdat</code> (<code>SAS</code>). L’utilisation
de ces formats est problématique car cela revient à se lier
les mains pour l’analyse ultérieure des données, surtout
lorsqu’il s’agit d’un format propriétaire (comme avec
<code>SAS</code> ou <code>Stata</code>). Par exemple, <code>Python</code> ne
sait pas nativement lire un <code>.sas7bdat</code>. Il existe des librairies
pour le faire (notamment <code>Pandas</code>) mais le format
étant propriétaire, les développeurs de la librairie ont dû tâtonner et
on n’est ainsi jamais assuré qu’il n’y ait pas d’altération de la donnée.</p>
<p>Malgré tous les inconvénients du <code>.csv</code> listés plus haut, il présente
l’immense avantage, par rapport à ces formats, de l’universalité.
Il vaut ainsi mieux privilégier un <code>.csv</code> à ces formats pour le stockage
de la donnée. Ceci dit, comme vise à le montrer ce chapitre, il vaut
mieux privilégier le format <code>parquet</code> au <code>CSV</code>.</p>
</div>
</div>
<p>Pour répondre à ces limites du <code>CSV</code>, le format <code>parquet</code>,
qui est un <a href="https://apache.org/">projet open-source <code>Apache</code></a>, a émergé.
La première différence entre le format <code>parquet</code> et le <code>CSV</code> est
que le premier repose sur un <strong>stockage orienté colonne</strong> là où
le second est orienté ligne. Pour comprendre la différence, voici un
exemple issu du <a href="https://www.upsolver.com/blog/apache-parquet-why-use">blog d’upsolver</a>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://www.upsolver.com/wp-content/uploads/2020/05/Screen-Shot-2020-05-26-at-17.52.58.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://www.upsolver.com/wp-content/uploads/2020/05/Screen-Shot-2020-05-26-at-17.52.58.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
<p>Dans notre exemple précédent, cela donnera une information prenant
la forme suivante (ignorez l’élément <code>pyarrow.Table</code>, nous
reviendrons dessus) :</p>
<div class="cell" data-execution_count="3">
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>pyarrow.Table
nom : string
profession: string
----
nom : [["Astérix ","Obélix ","Assurancetourix "]]
profession: [["","Tailleur de menhir","Barde"]]</code></pre>
</div>
</div>
<p>Pour reprendre l’exemple fil rouge :point_up:, il sera ainsi beaucoup plus
facile de récupérer la deuxième ligne de la colonne <code>profession</code>:
on ne considère que le vecteur <code>profession</code> et on récupère la deuxième
valeur.
Le requêtage d’échantillon de données ne nécessite donc pas l’import de
l’ensemble des données. A cela s’ajoute des fonctionnalités supplémentaires
des librairies d’import de données parquet (par exemple <code>pyarrow</code> ou <code>spark</code>)
qui vont faciliter des recherches complexes basées, par exemple, sur des
requêtes de type <code>SQL</code>, ou permettant l’utilisation de données plus volumineuses que la RAM.</p>
<p>Le format <code>parquet</code> présente d’autres avantages par rapport au
<code>CSV</code>:</p>
<ul>
<li>Le format <code>parquet</code> est (très) compressé, ce qui réduit la volumétrie
des données sur disque ;</li>
<li>Des métadonnées, notamment le typage des variables, sont stockées en complément dans le fichier.
Cette partie, nommée le <em>footer</em> du fichier <code>parquet</code>, permet que l’import des données soit
optimisé sans risque d’altération de celle-ci. Pour un producteur de données, c’est une manière
d’assurer la qualité des données. Par exemple, un fournisseur de
données de type code-barre sera
certain que les données <code>000012</code> ne seront pas considérées identiques à un code-barre <code>12</code>.</li>
<li>Il est possible de partitionner un jeu de données en fonction de différents niveaux (par
exemple des niveaux géographiques) en une arborescence de fichiers <code>parquet</code>. Cela
permet de travailler sur un échantillon pour facilement passer à l’échelle ensuite.
Par exemple, une structure partitionnée, empruntée
à la <a href="https://spark.apache.org/docs/latest/sql-data-sources-parquet.html#partition-discovery">documentation <code>Spark</code></a>
peut prendre la forme suivante :</li>
</ul>
<pre class="raw"><code>path
└── to
    └── table
        ├── gender=male
        │   ├── ...
        │   │
        │   ├── country=US
        │   │   └── data.parquet
        │   ├── country=CN
        │   │   └── data.parquet
        │   └── ...
        └── gender=female
            ├── ...
            │
            ├── country=US
            │   └── data.parquet
            ├── country=CN
            │   └── data.parquet
            └── ...</code></pre>
<p>Qu’on lise un ou plusieurs fichiers, on finira avec le schéma suivant :</p>
<pre class="raw"><code>root
|-- name: string (nullable = true)
|-- age: long (nullable = true)
|-- gender: string (nullable = true)
|-- country: string (nullable = true)</code></pre>
<p>Ces différents avantages expliquent le succès du format <code>parquet</code> dans le monde du
<em>big-data</em>. Le paragraphe suivant, extrait du <a href="">post d’upsolver</a> déjà cité,
résume bien l’intérêt:</p>
<blockquote class="blockquote">
<p>Complex data such as logs and event streams would need to be represented as a table with hundreds or thousands of columns, and many millions of rows. Storing this table in a row based format such as CSV would mean:</p>
<ul>
<li>Queries will take longer to run since more data needs to be scanned, rather than only querying the subset of columns we need to answer a query (which typically requires aggregating based on dimension or category)</li>
<li>Storage will be more costly since CSVs are not compressed as efficiently as Parquet</li>
</ul>
</blockquote>
<p>Cependant, <strong><code>Parquet</code> ne devrait pas intéresser que les producteurs ou utilisateurs de données <em>big-data</em></strong>.
C’est l’ensemble
des producteurs de données qui bénéficient des fonctionalités
de <code>Parquet</code>.</p>
<p>Pour en savoir plus sur <code>Arrow</code>,
des éléments supplémentaires sur <code>Parquet</code> sont disponibles sur ce très bon
post de blog d’<a href="https://www.upsolver.com/blog/apache-parquet-why-use">upsolver</a>
et <a href="https://parquet.apache.org/">sur la page officielle du projet <code>Parquet</code></a>.</p>
<section id="lire-un-parquet-en-python-la-librairie-pyarrow" class="level2">
<h2 class="anchored" data-anchor-id="lire-un-parquet-en-python-la-librairie-pyarrow">Lire un <code>parquet</code> en <code>Python</code>: la librairie <code>pyarrow</code></h2>
<p>La librairie <code>pyarrow</code> permet la lecture et l’écriture
de fichiers <code>parquet</code> avec <code>Python</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Elle repose
sur un type particulier de <em>dataframe</em>, le <code>pyarrow.Table</code>
qui peut être utilisé en substitut ou en complément
du <code>DataFrame</code>
de <code>pandas</code>. Il est recommandé de régulièrement
consulter la documentation officielle de <code>pyarrow</code>
concernant <a href="https://arrow.apache.org/docs/python/parquet.html">la lecture et écriture de fichiers</a> et celle relative
aux <a href="https://arrow.apache.org/cookbook/py/data.html">manipulations de données</a>.</p>
<p>Pour illustrer les fonctionalités de <code>pyarrow</code>,
repartons de notre CSV initial que nous allons
enrichir d’une nouvelle variable numérique
et que nous
allons
convertir en objet <code>pyarrow</code> avant de l’écrire au format <code>parquet</code>:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.parquet <span class="im">as</span> pq</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="st">nom;cheveux;profession</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="st">Astérix;blond;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="st">Obélix;roux;Tailleur de menhir</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="st">Assurancetourix;blond;Barde</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>source <span class="op">=</span> StringIO(s)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(source, sep <span class="op">=</span> <span class="st">";"</span>, index_col<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"taille"</span>] <span class="op">=</span> [<span class="dv">155</span>, <span class="dv">190</span>, <span class="dv">175</span>]</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> pa.Table.from_pandas(df)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>table</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>pq.write_table(table, <span class="st">'example.parquet'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell markdown">
<div class="alert alert-warning" role="alert">
<h3 class="alert-heading anchored"><i class="fa-solid fa-lightbulb"></i> Hint </h3>
<p>L’utilisation des noms <code>pa</code> pour <code>pyarrow</code> et <code>pq</code> pour
<code>pyarrow.parquet</code> est une convention communautaire
qu’il est recommandé de suivre.</p>
</div>
</div>
<p>Pour importer et traiter ces données, on peut conserver
les données sous le format <code>pyarrow.Table</code>
ou transformer en <code>pandas.DataFrame</code>. La deuxième
option est plus lente mais présente l’avantage
de permettre ensuite d’appliquer toutes les
manipulations offertes par l’écosystème
<code>pandas</code> qui est généralement mieux connu que
celui d’<code>Arrow</code>.</p>
<p>Supposons qu’on ne s’intéresse qu’à la taille et à la couleur
de cheveux de nos gaulois.
Il n’est pas nécessaire d’importer l’ensemble de la base, cela
ferait perdre du temps pour rien. On appelle
cette approche le <strong><code>column pruning</code></strong> qui consiste à
ne parcourir, dans le fichier, que les colonnes qui nous
intéressent. Du fait du stockage orienté colonne du <code>parquet</code>,
il suffit de ne considérer que les blocs qui nous
intéressent (alors qu’avec un CSV il faudrait scanner tout
le fichier avant de pouvoir éliminer certaines colonnes).
Ce principe du <code>column pruning</code> se matérialise avec
l’argument <code>columns</code> dans <code>parquet</code>.</p>
<p>Ensuite, avec <code>pyarrow</code>, on pourra utiliser <code>pyarrow.compute</code> pour
effectuer des opérations directement sur une table
<code>Arrow</code> :</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.compute <span class="im">as</span> pc</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> pq.read_table(<span class="st">'example.parquet'</span>, columns<span class="op">=</span>[<span class="st">'taille'</span>, <span class="st">'cheveux'</span>])</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>table.group_by(<span class="st">"cheveux"</span>).aggregate([(<span class="st">"taille"</span>, <span class="st">"mean"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La manière équivalente de procéder en passant
par l’intermédiaire de <code>pandas</code> est</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> pq.read_table(<span class="st">'example.parquet'</span>, columns<span class="op">=</span>[<span class="st">'taille'</span>, <span class="st">'cheveux'</span>])</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>table.to_pandas().groupby(<span class="st">"cheveux"</span>)[<span class="st">"taille"</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>cheveux
blond    165.0
roux     190.0
Name: taille, dtype: float64</code></pre>
</div>
</div>
<p>Ici, comme les données sont peu volumineuses, deux des
avantages du <code>parquet</code> par rapport
au <code>CSV</code> (données moins
volumineuses et vitesse de l’import)
ne s’appliquent pas vraiment.</p>
<div class="cell markdown">
<div class="alert alert-info" role="alert">
<h3 class="alert-heading anchored"><i class="fa-solid fa-comment"></i> Note</h3>
<p>Un autre principe d’optimisation de la performance qui est
au coeur de la librairie <code>Arrow</code> est le <code>filter pushdown</code>
(ou <code>predicate pushdown</code>).</p>
<p>Quand on exécute un filtre de sélection de ligne
juste après avoir chargé un jeu de données,
<code>Arrow</code> va essayer de le mettre en oeuvre lors de l’étape de lecture
et non après. Autrement dit, <code>Arrow</code> va modifier le plan
d’exécution pour pousser le filtre en amont de la séquence d’exécution
afin de ne pas essayer de lire les lignes inutiles.</p>
</div>
</div>
</section>
</section>
<section id="le-système-de-stockage-s3" class="level1">
<h1>Le système de stockage <code>S3</code></h1>
<p>Si les fichiers <code>parquet</code> sont une
solution avantageuse pour
les <em>data scientists</em>, ils ne résolvent
pas tous les inconvénients de
l’approche fichier.
En particulier, la question de la
duplication des données pour la mise
à disposition sécurisée des sources
n’est pas résolue. Pour que
l’utilisateur <code>B</code> n’altère pas les
données de l’utilisateur <code>A</code>, il est nécessaire
qu’ils travaillent sur deux fichiers
différents, dont l’un peut être une copie
de l’autre.</p>
</section>
<section id="les-données-sur-le-cloud" class="level1">
<h1>Les données sur le <em>cloud</em></h1>
<p>La mise à disposition de données dans
les systèmes de stockage <em>cloud</em> est
une réponse à ce problème.
Les <em>data lake</em> qui se sont développés dans les
institutions et entreprises utilisatrices de données</p>
<p>Le principe d’un stockage cloud
est le même que celui d’une
<code>Dropbox</code> ou d’un <code>Drive</code> mais adapté à
l’analyse de données. Un utilisateur de données
accède à un fichier stocké sur un serveur distant
<em>comme s’il</em> était dans son <em>file system</em> local<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.
Donc, du point de vue de l’utilisateur <code>Python</code>,
il n’y a pas de différence fondamentale. Cependant,
les données ne sont pas hebergées dans un dossier
local (par exemple <code>Mes Documents/monsuperfichier</code>)
mais sur un serveur distant auquel l’utilisateur
de <code>Python</code> accède à travers un échange réseau.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="featured.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="featured.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
<p>Dans l’univers du <em>cloud</em>, la hiérarchisation des données
dans des dossiers et des fichiers bien rangés
est d’ailleurs moins
importante que dans le monde du <em>file system</em> local.
Lorsque vous essayez de retrouver un fichier dans
votre arborescence de fichiers, vous utilisez parfois
la barre de recherche de votre explorateur de fichiers,
avec des résultats mitigés<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. Dans le monde du <em>cloud</em>,
les fichiers sont parfois accumulés de manière plus
chaotique car les outils de recherche sont plus
efficaces<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<p>En ce qui concerne la sécurité des données,
la gestion des droits de lecture et écriture peut être
fine: on peut autoriser certains utilisateurs uniquement
à la lecture, d’autres peuvent avoir les droits
d’écriture pour modifier les données. Cela permet
de concilier les avantages des bases de données (la sécurisation
des données) avec ceux des fichiers.</p>
<section id="quest-ce-que-le-système-de-stockage-s3" class="level2">
<h2 class="anchored" data-anchor-id="quest-ce-que-le-système-de-stockage-s3">Qu’est-ce que le système de stockage <code>S3</code> ?</h2>
<p>Dans les entreprises et administrations,
un nombre croissant de données sont
disponibles depuis un système de stockage
nommé <code>S3</code>.
Le système <code>S3</code> (<em>Simple Storage System</em>) est un système de stockage développé
par Amazon et qui est maintenant devenu une référence pour le stockage en ligne.
Il s’agit d’une architecture à la fois
sécurisée (données cryptées, accès restreints) et performante.</p>
<p>Le concept central du système S3 est le <strong><em>bucket</em></strong>.
Un <em>bucket</em> est un espace (privé ou partagé) où on peut stocker une
arborescence de fichiers. Pour accéder aux fichiers figurant
dans un <em>bucket</em> privé, il faut des jetons d’accès (l’équivalent d’un mot de passe)
reconnus par le serveur de stockage. On peut alors lire et écrire dans le <em>bucket</em>.</p>
<div class="cell markdown">
<div class="alert alert-info" role="alert">
<h3 class="alert-heading anchored"><i class="fa-solid fa-comment"></i> Note</h3>
<p>Les exemples suivants seront réplicables pour les utilisateurs de la plateforme
SSP Cloud</p>
<p><a href="https://datalab.sspcloud.fr/launcher/ide/jupyter-python?autoLaunch=true&amp;onyxia.friendlyName=%C2%ABpython-datascience%C2%BB&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fpython-datascientist%2Fmaster%2Fsspcloud%2Finit-jupyter.sh%C2%BB&amp;init.personalInitArgs=%C2%ABNLP%2005a_s3%C2%BB&amp;security.allowlist.enabled=false" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSP%20Cloud-Tester_avec_Jupyter-orange?logo=Jupyter&amp;logoColor=orange" alt="Onyxia"></a><a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=true&amp;onyxia.friendlyName=%C2%ABpython-datascience%C2%BB&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fpython-datascientist%2Fmaster%2Fsspcloud%2Finit-vscode.sh%C2%BB&amp;init.personalInitArgs=%C2%ABNLP%2005a_s3%C2%BB&amp;security.allowlist.enabled=false" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSP%20Cloud-Tester_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia"></a><br></p>
<p>Ils peuvent également l’être pour des utilisateurs ayant un
accès à AWS, il suffit de changer l’URL du <code>endpoint</code>
présenté ci-dessous.</p>
</div>
</div>
</section>
<section id="comment-faire-avec-python" class="level2">
<h2 class="anchored" data-anchor-id="comment-faire-avec-python">Comment faire avec Python ?</h2>
<section id="les-librairies-principales" class="level3">
<h3 class="anchored" data-anchor-id="les-librairies-principales">Les librairies principales</h3>
<p>L’interaction entre ce système distant de fichiers et une session locale de Python
est possible grâce à des API. Les deux principales librairies sont les suivantes :</p>
<ul>
<li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">boto3</a>, une librairie créée et maintenue par Amazon ;</li>
<li><a href="https://s3fs.readthedocs.io/en/latest/">s3fs</a>, une librairie qui permet d’interagir avec les fichiers stockés à l’instar d’un filesystem classique.</li>
</ul>
<p>La librairie <code>pyarrow</code> que nous avons déjà présentée permet également
de traiter des données stockées sur le <em>cloud</em> comme si elles
étaient sur le serveur local. C’est extrêmement pratique
et permet de fiabiliser la lecture ou l’écriture de fichiers
dans une architecture <em>cloud</em>.
Un exemple, assez court, est disponible
<a href="https://arrow.apache.org/docs/python/filesystems.html#s3">dans la documentation officielle</a></p>
<p>Il existe également d’autres librairies permettant de gérer
des <em>pipelines</em> de données (chapitre à venir) de manière
quasi indifférente entre une architecture locale et une architecture
<em>cloud</em>. Parmi celles-ci, nous présenterons quelques exemples
avec <code>snakemake</code>.
En arrière-plan, <code>snakemake</code>
va utiliser <code>boto3</code> pour communiquer avec le système
de stockage.</p>
<p>Enfin, selon le même principe du <em>comme si</em> les données
étaient en local, il existe l’outil en ligne de commande
<code>mc</code> (<a href="https://docs.min.io/docs/minio-client-complete-guide.html"><code>Minio Client</code></a>) qui permet de gérer par des lignes
de commande Linux les dépôts distants comme s’ils étaient
locaux.</p>
<p>Toutes ces librairies offrent la possibilité de se connecter depuis <code>Python</code>,
à un dépôt de fichiers distant, de lister les fichiers disponibles dans un
<em>bucket</em>, d’en télécharger un ou plusieurs ou de faire de l’<em>upload</em>
Nous allons présenter quelques-unes des opérations les plus fréquentes,
en mode <em>cheatsheet</em>.</p>
</section>
</section>
<section id="connexion-à-un-bucket" class="level2">
<h2 class="anchored" data-anchor-id="connexion-à-un-bucket">Connexion à un bucket</h2>
<p>Par la suite, on va utiliser des alias pour les trois valeurs suivantes, qui servent
à s’authentifier.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>key_id <span class="op">=</span> <span class="st">'MY_KEY_ID'</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>access_key <span class="op">=</span> <span class="st">'MY_ACCESS_KEY'</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>token <span class="op">=</span> <span class="st">"MY_TOKEN"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ces valeurs peuvent être également disponibles dans
les variables d’environnement de <code>Python</code>. Comme il s’agit d’une information
d’authentification personnelle, il ne faut pas stocker les vraies valeurs de ces
variables dans un projet, sous peine de partager des traits d’identité sans le
vouloir lors d’un partage de code.</p>
<div class="cell markdown">
<details><summary><code>boto3</code> 👇</summary>
<p>Avec <code>boto3</code>, on créé d’abord un client puis on exécute des requêtes dessus.
Pour initialiser un client, il suffit, en supposant que l’url du dépôt S3 est
<code>"https://minio.lab.sspcloud.fr"</code>, de faire:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> boto3.client(<span class="st">"s3"</span>,endpoint_url <span class="op">=</span> <span class="st">"https://minio.lab.sspcloud.fr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>S3FS</code> 👇</summary>
<p>La logique est identique avec <code>s3fs</code>.</p>
<p>Si on a des jetons d’accès à jour et dans les variables d’environnement
adéquates:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  client_kwargs<span class="op">=</span>{<span class="st">'endpoint_url'</span>: <span class="st">'https://minio.lab.sspcloud.fr'</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Arrow</code> 👇</summary>
<p>La logique d’<code>Arrow</code> est proche de celle de <code>s3fs</code>. Seuls les noms
d’arguments changent</p>
<p>Si on a des jetons d’accès à jour et dans les variables d’environnement
adéquates:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyarrow <span class="im">import</span> fs</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> fs.S3FileSystem(endpoint_override<span class="op">=</span><span class="st">"http://"</span><span class="op">+</span><span class="st">"minio.lab.sspcloud.fr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Snakemake</code> 👇</summary>
<p>La logique de <code>Snakemake</code> est, quant à elle,
plus proche de celle de <code>boto3</code>. Seuls les noms
d’arguments changent</p>
<p>Si on a des jetons d’accès à jour et dans les variables d’environnement
adéquates:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> snakemake.remote.S3 <span class="im">import</span> RemoteProvider <span class="im">as</span> S3RemoteProvider</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>S3 <span class="op">=</span> S3RemoteProvider(host <span class="op">=</span> <span class="st">"https://"</span> <span class="op">+</span> os.getenv(<span class="st">'AWS_S3_ENDPOINT'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Il se peut que la connexion à ce stade soit refusée (<code>HTTP error 403</code>).
Cela peut provenir
d’une erreur dans l’URL utilisé. Cependant, cela reflète plus généralement
des paramètres d’authentification erronés.</p>
<div class="cell markdown">
<details><summary><code>boto3</code> 👇</summary>
<p>Les paramètres d’authentification sont des arguments supplémentaires:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> boto3.client(<span class="st">"s3"</span>,endpoint_url <span class="op">=</span> <span class="st">"https://minio.lab.sspcloud.fr"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                  aws_access_key_id<span class="op">=</span>key_id, </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                  aws_secret_access_key<span class="op">=</span>access_key, </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                  aws_session_token <span class="op">=</span> token)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>S3FS</code> 👇</summary>
<p>La logique est la même, seuls les noms d’arguments diffèrent</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  client_kwargs<span class="op">=</span>{<span class="st">'endpoint_url'</span>: <span class="st">'https://'</span><span class="op">+</span><span class="st">'minio.lab.sspcloud.fr'</span>},</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  key <span class="op">=</span> key_id, secret <span class="op">=</span> access_key,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  token <span class="op">=</span> token)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Arrow</code> 👇</summary>
<p>Tout est en argument cette fois:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyarrow <span class="im">import</span> fs</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> fs.S3FileSystem(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    access_key <span class="op">=</span> key_id,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    secret_key <span class="op">=</span> access_key,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    session_token <span class="op">=</span> token,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    endpoint_override <span class="op">=</span> <span class="st">'https://'</span><span class="op">+</span><span class="st">'minio.lab.sspcloud.fr'</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    scheme <span class="op">=</span> <span class="st">"https"</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Snakemake</code> 👇</summary>
<p>La logique est la même, seuls les noms d’arguments diffèrent</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> snakemake.remote.S3 <span class="im">import</span> RemoteProvider <span class="im">as</span> S3RemoteProvider</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>S3 <span class="op">=</span> S3RemoteProvider(host <span class="op">=</span> <span class="st">"https://"</span> <span class="op">+</span> os.getenv(<span class="st">'AWS_S3_ENDPOINT'</span>), access_key_id<span class="op">=</span>key_id, secret_access_key<span class="op">=</span>access_key)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<div class="alert alert-info" role="alert">
<h3 class="alert-heading anchored"><i class="fa-solid fa-comment"></i> Note</h3>
<p>Dans le SSP Cloud,
lorsque l’initialisation du service <code>Jupyter</code> du SSP Cloud est récente
(moins de 12 heures), il est possible d’utiliser
automatiquement les jetons stockés automatiquement à la création du dépôt.</p>
<p>Si on désire accéder aux données du SSP Cloud depuis une session Python du
datalab (service VSCode, Jupyter…),
il faut remplacer l’url par <code>http://minio.lab.sspcloud.fr</code></p>
</div>
</div>
</section>
<section id="lister-les-fichiers" class="level2">
<h2 class="anchored" data-anchor-id="lister-les-fichiers">Lister les fichiers</h2>
<p>S’il n’y a pas d’erreur à ce stade, c’est que la connexion est bien effective.
Pour le vérifier, on peut essayer de faire la liste des fichiers disponibles
dans un <code>bucket</code> auquel on désire accéder.</p>
<p>Par exemple, on peut vouloir
tester l’accès aux bases <code>FILOSOFI</code> (données de revenu localisées disponibles
sur <a href="https://www.insee.fr" class="uri">https://www.insee.fr</a>) au sein du bucket <code>donnees-insee</code>.</p>
<div class="cell markdown">
<details><summary><code>boto3</code> 👇</summary>
<p>Pour cela,
la méthode <code>list_objects</code> offre toutes les options nécessaires:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> boto3.client(<span class="st">"s3"</span>,endpoint_url <span class="op">=</span> <span class="st">"https://minio.lab.sspcloud.fr"</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key <span class="kw">in</span> s3.list_objects(Bucket<span class="op">=</span><span class="st">'donnees-insee'</span>, Prefix<span class="op">=</span><span class="st">'diffusion/FILOSOFI'</span>)[<span class="st">'Contents'</span>]:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(key[<span class="st">'Key'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>S3FS</code> 👇</summary>
<p>Pour lister les fichiers, c’est la méthode <code>ls</code> (celle-ci ne liste pas par
défaut les fichiers de manière récursive comme <code>boto3</code>):</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  client_kwargs<span class="op">=</span>{<span class="st">'endpoint_url'</span>: <span class="st">'https://minio.lab.sspcloud.fr'</span>})</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>fs.ls(<span class="st">"donnees-insee/diffusion"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Arrow</code> 👇</summary>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyarrow <span class="im">import</span> fs</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> fs.S3FileSystem(endpoint_override<span class="op">=</span><span class="st">'https://'</span><span class="op">+</span><span class="st">'minio.lab.sspcloud.fr'</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>s3.get_file_info(fs.FileSelector(<span class="st">'donnees-insee/diffusion'</span>, recursive<span class="op">=</span><span class="va">True</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>mc</code> 👇</summary>
<pre class="shell"><code>mc ls -r</code></pre>
</details>
</div>
</section>
<section id="télécharger-un-fichier-depuis-s3-pour-lenregistrer-en-local" class="level2">
<h2 class="anchored" data-anchor-id="télécharger-un-fichier-depuis-s3-pour-lenregistrer-en-local">Télécharger un fichier depuis <code>S3</code> pour l’enregistrer en local</h2>
<p>Cette méthode n’est en général pas recommandée car, comme on va le voir
par la suite, il est possible de lire à la volée des fichiers. Cependant,
télécharger un fichier depuis le <em>cloud</em> pour l’écrire sur le disque
local peut parfois être utile (par exemple, lorsqu’il est nécessaire
de dézipper un fichier).</p>
<div class="cell markdown">
<details><summary><code>boto3</code> 👇</summary>
<p>On utilise cette fois la méthode <code>download_file</code></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> boto3.client(<span class="st">"s3"</span>,endpoint_url <span class="op">=</span> <span class="st">"https://minio.lab.sspcloud.fr"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>s3.download_file(<span class="st">'donnees-insee'</span>, <span class="st">"diffusion/FILOSOFI/2014/FILOSOFI_COM.csv"</span>, <span class="st">'data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>S3FS</code> 👇</summary>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  client_kwargs<span class="op">=</span>{<span class="st">'endpoint_url'</span>: <span class="st">'https://minio.lab.sspcloud.fr'</span>})</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>fs.download(<span class="st">'donnees-insee/diffusion/FILOSOFI/2014/FILOSOFI_COM.csv'</span>,<span class="st">'test.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Snakemake</code> 👇</summary>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> snakemake.remote.S3 <span class="im">import</span> RemoteProvider <span class="im">as</span> S3RemoteProvider</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>S3 <span class="op">=</span> S3RemoteProvider(host <span class="op">=</span> <span class="st">"https://"</span> <span class="op">+</span> os.getenv(<span class="st">'AWS_S3_ENDPOINT'</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> <span class="st">"mon-bucket"</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>rule ma_super_regle_s3:</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        fichier <span class="op">=</span> S3.remote(<span class="ss">f'</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/moninput.csv'</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        fichier<span class="op">=</span><span class="st">'mon_dossier_local/monoutput.csv'</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    run:</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        shell(<span class="st">"cp </span><span class="sc">{input[0]}</span><span class="st"> </span><span class="sc">{output[0]}</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>mc</code> 👇</summary>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>mc cp <span class="st">"donnees-insee/FILOSOFI/2014/FILOSOFI_COM.csv"</span> <span class="st">'data.csv'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="lire-un-fichier-directement" class="level2">
<h2 class="anchored" data-anchor-id="lire-un-fichier-directement">Lire un fichier directement</h2>
<p>La méthode précédente n’est pas optimale. En effet, l’un des intérêts des API
est qu’on peut traiter un fichier sur <code>S3</code> comme s’il s’agissait d’un fichier
sur son PC. Cela est d’ailleurs une manière plus sécurisée de procéder puisqu’on
lit les données à la volée, sans les écrire dans un filesystem local.</p>
<div class="cell markdown">
<details><summary><code>boto3</code> 👇</summary>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> boto3.client(<span class="st">"s3"</span>,endpoint_url <span class="op">=</span> <span class="st">"https://minio.lab.sspcloud.fr"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>obj <span class="op">=</span> s3.get_object(Bucket<span class="op">=</span><span class="st">'donnees-insee'</span>, Key<span class="op">=</span><span class="st">"diffusion/FILOSOFI/2014/FILOSOFI_COM.csv"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(obj[<span class="st">'Body'</span>], sep <span class="op">=</span> <span class="st">";"</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>S3FS</code> 👇</summary>
<p>Le code suivant devrait permettre d’effectuer la même opération avec <code>s3fs</code></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  client_kwargs<span class="op">=</span>{<span class="st">'endpoint_url'</span>: <span class="st">'https://minio.lab.sspcloud.fr'</span>})</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(fs.<span class="bu">open</span>(<span class="st">'</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="st">'donnees-insee'</span>, <span class="st">"diffusion/FILOSOFI/2014/FILOSOFI_COM.csv"</span>),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                         mode<span class="op">=</span><span class="st">'rb'</span>), sep <span class="op">=</span> <span class="st">";"</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Snakemake</code> 👇</summary>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> snakemake.remote.S3 <span class="im">import</span> RemoteProvider <span class="im">as</span> S3RemoteProvider</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>S3 <span class="op">=</span> S3RemoteProvider(host <span class="op">=</span> <span class="st">"https://"</span> <span class="op">+</span> os.getenv(<span class="st">'AWS_S3_ENDPOINT'</span>))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> <span class="st">"mon-bucket"</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>rule ma_super_regle_s3:</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        fichier <span class="op">=</span> S3.remote(<span class="ss">f'</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/moninput.csv'</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    run:</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(<span class="bu">input</span>.fichier)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># PLUS D'OPERATIONS</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Arrow</code> 👇</summary>
<p><code>Arrow</code> est une librairie qui permet de lire des <code>CSV</code>.
Il est néanmoins
beaucoup plus pratique d’utiliser le format <code>parquet</code> avec <code>arrow</code>.
Dans un premier temps, on configure le <em>filesystem</em> avec les
fonctionalités d’<code>Arrow</code> (cf.&nbsp;précédemment).</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyarrow <span class="im">import</span> fs</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> fs.S3FileSystem(endpoint_override<span class="op">=</span><span class="st">'http://'</span><span class="op">+</span><span class="st">'minio.lab.sspcloud.fr'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pour lire un csv, on fera:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyarrow <span class="im">import</span> fs</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyarrow <span class="im">import</span> csv</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> fs.S3FileSystem(endpoint_override<span class="op">=</span><span class="st">'https://'</span><span class="op">+</span><span class="st">'minio.lab.sspcloud.fr'</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> s3.open_input_file(<span class="st">"donnees-insee/diffusion/FILOSOFI/2014/FILOSOFI_COM.csv"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> csv.read_csv(<span class="bu">file</span>, parse_options<span class="op">=</span>csv.ParseOptions(delimiter<span class="op">=</span><span class="st">";"</span>)).to_pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Pour un fichier au format parquet, la démarche est plus simple grâce à l’argument
<code>filesystem</code> dans <code>pyarrow.parquet.ParquetDataset</code> :</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.parquet <span class="im">as</span> pq</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">#bucket = ""</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">#parquet_file=""</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pq.ParquetDataset(<span class="ss">f'</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>parquet_file<span class="sc">}</span><span class="ss">'</span>, filesystem<span class="op">=</span>s3).read_pandas().to_pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="uploader-un-fichier" class="level2">
<h2 class="anchored" data-anchor-id="uploader-un-fichier">Uploader un fichier</h2>
<div class="cell markdown">
<details><summary><code>boto3</code> 👇</summary>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>s3.upload_file(file_name, bucket, object_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>S3FS</code> 👇</summary>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fs.put(filepath, <span class="ss">f"</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>object_name<span class="sc">}</span><span class="ss">"</span>, recursive<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Arrow</code> 👇</summary>
<p>Supposons que <code>df</code> soit un <code>pd.DataFrame</code>
Dans un système local, on convertirait
en table <code>Arrow</code> puis on écrirait en <code>parquet</code>
(<a href="https://arrow.apache.org/docs/python/parquet.html#reading-and-writing-single-files">voir la documentation officielle</a>).
Quand on est sur un système <code>S3</code>, il s’agit seulement d’ajouter
notre connexion à <code>S3</code> dans l’argument <code>filesystem</code>
(<a href="https://arrow.apache.org/docs/python/filesystems.html#filesystem-s3">voir la page sur ce sujet dans la documentation Arrow</a>)</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.parquet <span class="im">as</span> pq</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> pa.Table.from_pandas(df)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>pq.write_table(table, <span class="ss">f"</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">"</span>, filesystem<span class="op">=</span>s3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>Snakemake</code> 👇</summary>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> snakemake.remote.S3 <span class="im">import</span> RemoteProvider <span class="im">as</span> S3RemoteProvider</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>S3 <span class="op">=</span> S3RemoteProvider(host <span class="op">=</span> <span class="st">"https://"</span> <span class="op">+</span> os.getenv(<span class="st">'AWS_S3_ENDPOINT'</span>))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> <span class="st">"mon-bucket"</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>rule ma_super_regle_s3:</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        fichier<span class="op">=</span><span class="st">'mon_dossier_local/moninput.csv'</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>        fichier<span class="op">=</span>S3.remote(<span class="ss">f'</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/monoutput.csv'</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    run:</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        shell(<span class="st">"cp output.fichier input.fichier"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<details><summary><code>mc</code> 👇</summary>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>mc cp <span class="st">'data.csv'</span> <span class="st">"MONBUCKET/monoutput.csv"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="pour-aller-plus-loin" class="level2">
<h2 class="anchored" data-anchor-id="pour-aller-plus-loin">Pour aller plus loin</h2>
<ul>
<li><a href="https://docs.sspcloud.fr/onyxia-guide/stockage-de-donnees">La documentation sur MinIO du SSPCloud</a></li>
</ul>


</section>
</section>


<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Elle permet aussi la lecture et l’écriture
de <code>.csv</code>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>D’ailleurs, les générations n’ayant connu nativement
que ce type de stockage ne sont pas familiarisées
au concept de <em>file system</em> et préfèrent
payer le temps de recherche. Voir
<a href="https://futurism.com/the-byte/gen-z-kids-file-systems">cet article</a>
sur le sujet.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>D’ailleurs, les générations n’ayant connu nativement
que ce type de stockage ne sont pas familiarisées
au concept de <em>file system</em> et préfèrent
payer le temps de recherche. Voir
<a href="https://futurism.com/the-byte/gen-z-kids-file-systems">cet article</a>
sur le sujet.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>D’ailleurs, les générations n’ayant connu nativement
que ce type de stockage ne sont pas familiarisées
au concept de <em>file system</em> et préfèrent
payer le temps de recherche. Voir
<a href="https://futurism.com/the-byte/gen-z-kids-file-systems">cet article</a>
sur le sujet.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@book{galiana2023,
  author = {Galiana, Lino},
  title = {Python Pour La Data Science},
  date = {2023},
  url = {https://pythonds.linogaliana.fr/},
  doi = {10.5281/zenodo.8229676},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-galiana2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Galiana, Lino. 2023. <em>Python Pour La Data Science</em>. <a href="https://doi.org/10.5281/zenodo.8229676">https://doi.org/10.5281/zenodo.8229676</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="linogaliana/python-datascientist" data-repo-id="MDEwOlJlcG9zaXRvcnkyODAxNjE2Nzc=" data-category="General" data-category-id="DIC_kwDOELLtjc4B-5TX" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>

<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../content/modern-ds/dallE.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Génération d’images avec Python, DALL-E et StableDiffusion</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../content/modern-ds/elastic_approfondissement.html" class="pagination-link">
        <span class="nav-page-text">Approfondissement ElasticSearch pour des recherches de proximité géographique</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Python pour la <em>data science</em>, Lino Galiana.<br>
Licence <i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i><br>
Code source disponible sur <a href="https://github.com/linogaliana/python-datascientist"><code>Github</code></a></div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Site construit avec <i class="fa-brands fa-python" aria-label="python"></i> et <a href="https://quarto.org/"><code>Quarto</code></a><br>
Inspiration pour la mise en forme du site <a href="https://www.andreashandel.com">ici</a><br>
<a href="https://github.com/linogaliana/python-datascientist">Code source disponible sur <i class="fa-brands fa-github" aria-label="github"></i> <code>GitHub</code></a></div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"selector":".lightbox","openEffect":"zoom","closeEffect":"zoom","loop":true,"descPosition":"bottom"});</script>



</body></html>